# YDB Query Metrics

## Описание

YDB Query Metrics - это консольная утилита для обработки и анализа данных, выгруженных из системных вью YDB. Инструмент позволяет загружать, фильтровать и анализировать метрики производительности SQL-запросов, собранных из YDB, предоставляя подробную статистику по времени выполнения, использованию CPU, операциям чтения/записи и другим параметрам.

## Установка

```bash
git clone https://github.com/senjaster/ydb-query-metrics
cd ydb-query-metrics
./ydb-query-metrics.sh --help
```

Скрипт автоматически создаст виртуальное окружение python и установит необходимые пакеты.

## Использование

### Базовое использование

```bash
./ydb-query-metrics.sh --like "some_table" query_metrics_one_minute.tsv
```
Данная команда прочитает файл query_metrics_one_minute.tsv и выведет в консоль все запросы, в тексте которых встречается some_table.
Значение, указанное в like интерпретируется как строка, которую нужно найти, т.е. специальные символы * или % тут не поддерживаются.

### Обработка нескольких файлов


```bash
./ydb-query-metrics.sh --like "some_table" query_metrics/*.tsv
```

Данная команда прочитает все файлы .tsv из папки query_metrics

### Сложная фильтрация запросов

Поддерживается указание нескольких фильтров, при этом подразумевается AND между всеми условиями. 
Это удобно использовать для исключения нежелательных запросов, например если нас не интересуют запросы, изменяющие данные, мы можем запустить следующую команду:
```bash
./ydb-query-metrics.sh example.tsv --like some_table --not-like "UPSERT" --not-like "MERGE"
```
Будут отобраны запросы, содержащие some_table и при этом не содержащие ни UPSERT, ни MERGE.

### Фильтрация по регулярному выражению

Помимо простой фильтрации по наличию/отсутствию значения, можно использовать параметр regex для поиска по регулярному выражению.

```bash
./ydb-query-metrics.sh examples/example.tsv --regex "FROM.*table_name"
```

Будут выведены запросы, которые содержат table_name после FROM. Можно свободно комбинировать условия `--regex`, `--like` и `--not-like`.

### Сортировка

Запросы можно сортировать по максимальной или средней длительности и по максимальному или среднему потреблению CPU. Сортировка всегда идет по убыванию значения.

```bash
./ydb-query-metrics.sh input/example.tsv --like table_name --sort-by AvgCPUTime
```

### Вывод в файлы

Вывод результатов в отдельные SQL-файлы:
```bash
./ydb-query-metrics.sh input/example.tsv --to-files
```

Вывод всех запросов в один файл:
```bash
./ydb-query-metrics.sh input/example.tsv --to-files --one-file
```

Указание директории для вывода:
```bash
./ydb-query-metrics.sh input/example.tsv --to-files --output-dir my_queries
```

### Дополнительные опции

По умолчанию текст sql-запросов переформатируется для лучшей читаемости.
Если это не требуется, нужно указать ключ `--keep-query-format`:
```bash
./ydb-query-metrics.sh input/example.tsv --keep-query-format
```

## Поддерживаемые форматы файлов

Утилита поддерживает два формата TSV-файлов:

1. **query_metrics** - данные, выгруженные из `.sys/query_metrics_one_minute`. Это предпочтительный формат файла, т.к. в нем больше данных.
2. **top_queries** - данные, выгруженные из `.sys/top_queries_by_duration_one_minute` и аналогичных. Нужно учитывать, что данные, полученные из этого вью дадут неправильные средние и минимальные значения.

Утилита автоматически определяет формат файла, но вы можете явно указать его с помощью параметра `--format`:

```bash
./ydb-query-metrics.sh input/example.tsv --format query_metrics
```

Желательно, чтобы в TSV-файлах были заголовки - это позволит более надежно определить формат файла.


## Вывод результатов

Для каждого уникального запроса утилита выводит:

1. Текст SQL-запроса 
2. Статистику выполнения в виде таблицы:
   - Время выполнения (мин/сред/макс)
   - Потребление CPU (мин/сред/макс)
   - Количество прочитанных строк (мин/сред/макс)
   - Количество прочитанных байт (мин/сред/макс)
   - Количество обновленных строк (мин/сред/макс)
   - Количество обновленных байт (мин/сред/макс)
3. Производные метрики:
   - Строк в секунду
   - Средний размер строки в байтах

## Пример выводимых данных

```
-- Query #1 (MaxDuration: 1.810002 seconds)

/*
Row count: 106
Total count: 106.0

Statistic       Min             Avg             Max            
--------------- --------------- --------------- ---------------
Duration (s)    0.000013        0.017075        1.810002       
CPUTime (s)     0.000012        0.000050        0.005298       
ReadRows        159             383.37          684            
ReadBytes       22036           56.49k          103920         
UpdateRows      0               0               0              
UpdateBytes     0               0               0              
--------------- --------------- --------------- ---------------
Rows/second     22.45                           
Bytes/row       147.35                          
*/

DECLARE $param1 AS List<Text?>;
SELECT
    b1_0.id,
    a1_0.id,
    a1_0.code,
    ...
```