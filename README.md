# YDB Query Metrics

## Описание

YDB Query Metrics - это консольная утилита для обработки и анализа данных, выгруженных из системных вью YDB. Инструмент позволяет загружать, фильтровать и анализировать метрики производительности SQL-запросов, собранных из YDB, предоставляя подробную статистику по времени выполнения, использованию CPU, операциям чтения/записи и другим параметрам.

## Установка

### C использованием pipx
Рекомендованный способ установки - использовать pipx:
```bash
pipx install git+https://github.com/senjaster/ydb-query-metrics
```
После выполнения этой команды ydb-query-metrics будет добавлена в PATH и ее можно будет запускать как обычное приложение.

### Скачать репозиторий
Если pipx нет, то нужно просто скачать репозиторий проекта:
```bash
git clone https://github.com/senjaster/ydb-query-metrics
cd ydb-query-metrics
./ydb-query-metrics.sh --help
```
При первом запуске будет автоматически создано виртуальное окружение python, в котором будет запускаться приложение.
В дальнейшем вместо команды `ydb-query-metrics` нужно будет запускать скрипт `./ydb-query-metrics.sh` из той папки, куда было установлено приложение.

## Использование

### Базовое использование

```bash
# При установке с помощью pipx
ydb-query-metrics --like "some_table" query_metrics_one_minute.tsv
```
 или

```bash
# При установке с помощью копирования репозитория
./ydb-query-metrics.sh --like "some_table" query_metrics_one_minute.tsv
```

Данная команда прочитает файл query_metrics_one_minute.tsv, создаст папку output/YYYYMMDD_hhmmss/ и запишет в нее все запросы, в тексте которых встречается some_table.
Каждый запрос будет записан в отдельный файл вида Query001.sql, причем запросы будут отсортированы по максимальной длительности - от самых медленных к самым быстрым.
Значение, указанное параметре like интерпретируется как строка, которую нужно найти, т.е. специальные символы * или % здесь не поддерживаются.

### Обработка нескольких файлов

```bash
ydb-query-metrics <параметры> query_metrics/*.tsv
```

Данная команда прочитает все файлы .tsv из папки query_metrics

### Сложная фильтрация запросов

Поддерживается указание нескольких фильтров, при этом подразумевается AND между всеми условиями. 
Это удобно использовать для исключения нежелательных запросов, например если нас не интересуют запросы, изменяющие данные, мы можем запустить следующую команду:
```bash
ydb-query-metrics example.tsv --like some_table --not-like UPSERT --not-like MERGE
```
Будут отобраны запросы, содержащие some_table и при этом не содержащие ни UPSERT, ни MERGE.

### Фильтрация по регулярному выражению

Помимо простой фильтрации по наличию/отсутствию значения, можно использовать параметр regex для поиска по регулярному выражению.

```bash
ydb-query-metrics examples/example.tsv --regex "FROM.*table_name"
```

Будут выведены запросы, которые содержат table_name после FROM. Можно свободно комбинировать условия `--regex`, `--like` и `--not-like`.

### Сортировка

Запросы можно сортировать по максимальной или средней длительности и по максимальному или среднему потреблению CPU. Сортировка всегда идет по убыванию значения.

```bash
ydb-query-metrics input/example.tsv --like table_name --sort-by AvgCPUTime
```

### Вывод результатов

По умолчанию каждый запрос записывается в отдельный SQL-файл в директории output/YYYYMMDD_hhmmss/. Директория создается автоматически.

Можно явно указать директорию, в которую нужно записывать файлы:
```bash
ydb-query-metrics input/example.tsv --like my_table --output-dir my_table_queries 
```

По умолчанию ydb-query-metrics не перезаписывает существующие файлы, поэтому если директория my_table_queries уже существует и в ней есть файлы, то будет выдана ошибка.
Если файлы все же нужно перезаписать, укажите дополнительно флаг --overwite:
```bash
ydb-query-metrics input/example.tsv --like my_table --output-dir my_table_queries --overwrite
```
Обратите внимание, что этот флаг удалит **все** файлы в папке my_table_queries, даже те, расширение которых не sql!

Если это требуется, можно записать все запросы в один файл - для этого нужно использовать параметр --output:
```bash
ydb-query-metrics input/example.tsv --like my_table --output my_table_queries.sql 
```

Кроме того, можно отправить запросы в stdout. Для этого вместо имени файла нужно указать дефис:
```bash
ydb-query-metrics input/example.tsv --like my_table --output - 
```

### Дополнительные опции

По умолчанию текст sql-запросов переформатируется для лучшей читаемости.
Если это не требуется, нужно указать ключ `--keep-query-format`:
```bash
ydb-query-metrics input/example.tsv --keep-query-format <параметры>
```

## Поддерживаемые форматы файлов

Утилита поддерживает два формата TSV-файлов:

1. **query_metrics** - данные, выгруженные из `.sys/query_metrics_one_minute`. Это предпочтительный формат файла, т.к. в нем больше данных.
2. **top_queries** - данные, выгруженные из `.sys/top_queries_by_duration_one_minute` и аналогичных. Нужно учитывать, что данные, полученные из этого вью дадут неправильные средние и минимальные значения.

Обычно формат файла определяется автоматически, но вы можете явно указать его с помощью параметра `--format`:

```bash
ydb-query-metrics input/example.tsv --format query_metrics <параметры>
```

Желательно, чтобы в TSV-файлах были заголовки - это позволит более надежно определить формат файла.


## Вывод результатов

Для каждого уникального запроса утилита выводит:

1. Текст SQL-запроса 
2. Статистику выполнения в виде таблицы:
   - Время выполнения (мин/сред/макс)
   - Потребление CPU (мин/сред/макс)
   - Количество прочитанных строк (мин/сред/макс)
   - Количество прочитанных байт (мин/сред/макс)
   - Количество обновленных строк (мин/сред/макс)
   - Количество обновленных байт (мин/сред/макс)
3. Производные метрики:
   - Строк в секунду
   - Средний размер строки в байтах

## Пример выводимых данных

```
-- Query #1 (MaxDuration: 1.810002 seconds)

/*
Row count: 21
Total count: 106.0

Statistic       Min             Avg             Max            
--------------- --------------- --------------- ---------------
Duration (s)    0.000013        0.017075        1.810002       
CPUTime (s)     0.000012        0.000050        0.005298       
ReadRows        159             383.37          684            
ReadBytes       22.04k          56.49k          103.92k         
UpdateRows      0               0               0              
UpdateBytes     0               0               0              
--------------- --------------- --------------- ---------------
Rows/second                     22.45                           
Bytes/row                       147.35                          
*/

DECLARE $param1 AS List<Text?>;
SELECT
    b1_0.id,
    a1_0.id,
    a1_0.code,
    ...
```