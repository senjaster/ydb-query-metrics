# YDB Query Metrics

## Описание

YDB Query Metrics - это консольная утилита для обработки и анализа данных, выгруженных из системных вью YDB. Инструмент позволяет загружать, фильтровать и анализировать метрики производительности SQL-запросов, собранных из YDB, предоставляя подробную статистику по времени выполнения, использованию CPU, операциям чтения/записи и другим параметрам.

## Установка

### Требования

- Python 3.6+
- pandas >= 1.3.0
- click >= 8.0.0
- sqlparse >= 0.4.2

### Установка из исходного кода

```bash
git clone <url-репозитория>
cd ydb-query-metrics
pip install -r requirements.txt
```

## Использование

### Базовое использование

```bash
python -m src.ydb-query-metrics --like "some_table" <файлы-tsv>
```
Данная команда выведет в консоль все запросы, в тексте которых встречается some_table.
Значение, указанное в like интерпретируется как строка, которую нужно найти, т.е. специальные символы * или % тут не поддерживаются.

### Сложная фильтрация запросов

Поддерживается указание нескольких фильтров, при этом подразумевается AND между всеми условиями. 
Это удобно использовать для исключения нежелательных запросов, например если нас не интекресуют запросы, изменяющие данные, мы можем запустить 
```bash
python -m src.ydb-query-metrics examples/example.tsv --like some_table --not-like "UPSERT" --not-like "MERGE"
```
Будут отобраны запросы, содержащие some_table и при этом не содержащие ни UPSERT, ни MERGE.

### Фильтрация по регулярному выражению

Помимо простой фильтрации по наличию/отстутствию значения, можно использовать параметр regex для поиска по регулярному выражению.

```bash
python -m src.ydb-query-metrics examples/example.tsv --regex "FROM.*table_name"
```

Будут выведены запросы, которые содержат table_name после FROM.
Можно свободно комбинировать --regex, --like и --not-like.

### Вывод в файлы

Вывод результатов в отдельные SQL-файлы:
```bash
python -m src.ydb-query-metrics examples/example.tsv --to-files
```

Вывод всех запросов в один файл:
```bash
python -m src.ydb-query-metrics examples/example.tsv --to-files --one-file
```

Указание директории для вывода:
```bash
python -m src.ydb-query-metrics examples/example.tsv --to-files --output-dir my_queries
```

### Дополнительные опции

Отключение форматирования SQL:
```bash
python -m src.ydb-query-metrics examples/example.tsv --no-format
```

Указание формата входного файла:
```bash
python -m src.ydb-query-metrics examples/example.tsv --format query_metrics
```

## Поддерживаемые форматы файлов

Утилита поддерживает два формата TSV-файлов:

1. **query_metrics** - данные, выгруженные из `.sys/query_metrics_one_minute`. Это предпочтительный формат файла, т.к. в нем больше данных
2. **top_queries** - данные, выгруженные из `.sys/top_queries_by_duration_one_minute` и аналогичных. Нужно учитывать, что данные, полученные из этого вью дадут неправильные средние и минимальные значения.

Утилита автоматически определяет формат файла, но вы можете явно указать его с помощью параметра `--format`.
Желательно, чтобы в tsv файлах были заголовки - это позволит более надежно определить формат файла по нему.


## Вывод результатов

Для каждого уникального запроса утилита выводит:

1. Текст SQL-запроса (отформатированный, если не указан `--no-format`)
2. Статистику выполнения в виде таблицы:
   - Время выполнения (мин/сред/макс)
   - Потребление CPU (мин/сред/макс)
   - Количество прочитанных строк (мин/сред/макс)
   - Количество прочитанных байт (мин/сред/макс)
   - Количество обновленных строк (мин/сред/макс)
   - Количество обновленных байт (мин/сред/макс)
3. Производные метрики:
   - Строк в секунду
   - Средний размер строки в байтах

## Примеры вывода

При выводе в консоль:
```
-- Query #1 (MaxDuration: 1.810002 seconds)

/*
Row count: 106
Total count: 106.0

Statistic       Min             Avg             Max            
--------------- --------------- --------------- ---------------
Duration (s)    0.000013        0.017075        1.810002       
CPUTime (s)     0.000012        0.000050        0.005298       
ReadRows        159             383.37          684            
ReadBytes       22036           56.49k          103920         
UpdateRows      0               0               0              
UpdateBytes     0               0               0              
--------------- --------------- --------------- ---------------
Rows/second     22.45                           
Bytes/row       147.35                          
*/

DECLARE $jp1 AS List<Text?>;
SELECT
    b1_0.id,
    a1_0.id,
    a1_0.code,
    ...
```

## Примечания

- Утилита автоматически определяет кодировку входных файлов
- Можно за раз обработать много файлов, указав имя со звездочкой